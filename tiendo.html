<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Tiến độ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.bootstrap5.min.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/2.0.8/js/dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/2.0.8/js/dataTables.bootstrap5.min.js"></script>
    <style>
        body { background: #f8f9fa; }
        .header { background: #0d6efd; color: white; padding: 15px; text-align: center; }
    </style>
</head>
<body>

<div class="header">
    <h3>QUẢN LÝ TIẾN ĐỘ ĐỒ ÁN</h3>
    <a href="index.html" class="btn btn-light btn-sm">← Về trang chủ</a>
</div>

<div class="container my-5">
    <div class="mb-3 text-end">
        <button class="btn btn-success" id="btnThemMoi">
            <i class="bi bi-plus-lg"></i> Thêm tiến độ mới
        </button>
    </div>

    <table class="table table-bordered table-hover" id="tblTienDo">
        <thead class="table-primary">
            <tr>
                <th>Mã đăng ký</th>
                <th>Mốc</th>
                <th>Ngày nộp</th>
                <th>Nhận xét</th>
                <th>Điểm</th>
                <th>Trạng thái</th>
                <th>Thao tác</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- Modal Thêm/Sửa tiến độ -->
<div class="modal fade" id="modalTienDo" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Thêm tiến độ mới</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formTienDo">
                    <input type="hidden" id="id">
                    <div class="mb-3">
                        <label>Mã đăng ký</label>
                        <input type="text" class="form-control" id="ma_dk" required>
                    </div>
                    <div class="mb-3">
                        <label>Mốc</label>
                        <select class="form-select" id="moc" required>
                            <option value="">Chọn mốc</option>
                            <option value="de_cuong">Đề cương</option>
                            <option value="giua_ky">Giữa kỳ</option>
                            <option value="cuoi_ky">Cuối kỳ</option>
                            <option value="slide_bao_ve">Slide bảo vệ</option>
                            <option value="khac">Khác</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label>Ngày nộp</label>
                        <input type="date" class="form-control" id="ngay_nop">
                    </div>
                    <div class="mb-3">
                        <label>Nhận xét</label>
                        <textarea class="form-control" id="nhan_xet" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label>Điểm</label>
                        <input type="number" class="form-control" id="diem" step="0.1" min="0" max="10">
                    </div>
                    <div class="mb-3">
                        <label>Trạng thái</label>
                        <select class="form-select" id="trang_thai" required>
                            <option value="">Chọn trạng thái</option>
                            <option value="chua_nop">Chưa nộp</option>
                            <option value="da_nop">Đã nộp</option>
                            <option value="da_duyet">Đã duyệt</option>
                            <option value="can_chinh_sua">Cần chỉnh sửa</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" id="btnLuuTienDo">Lưu</button>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function () {
    let table = $('#tblTienDo').DataTable({
        "pageLength": 10,
        "lengthMenu": [5, 10, 25, 50, "Tất cả"],
        "searching": true,
        "paging": true,
        "ordering": true,
        "info": true,
        "destroy": true // Cho phép khởi tạo lại nếu cần
    });

    // Hàm load dữ liệu từ API
    function loadTienDo() {
        $.ajax({
            url: 'api/tiendo_api.php',
            method: 'GET',
            dataType: 'json',
            success: function (data) {
                console.log('Dữ liệu tiến độ từ API:', data); // Debug: mở F12 → Console xem dữ liệu có về không

                table.clear().draw();

                if (!data || data.length === 0) {
                    table.row.add(['', '<i>Chưa có tiến độ nào</i>', '', '', '', '', '']).draw();
                    return;
                }

                data.forEach(item => {
                    let trangThaiBadge = '';
                    switch (item.trang_thai) {
                        case 'da_duyet': trangThaiBadge = 'bg-success'; break;
                        case 'da_nop': trangThaiBadge = 'bg-info'; break;
                        case 'can_chinh_sua': trangThaiBadge = 'bg-warning'; break;
                        default: trangThaiBadge = 'bg-secondary';
                    }

                    table.row.add([
                        item.dang_ky_id,
                        item.moc,
                        item.ngay_nop || '-',
                        item.nhan_xet || '-',
                        item.diem !== null ? item.diem : '-',
                        `<span class="badge ${trangThaiBadge}">${item.trang_thai}</span>`,
                        `<button class="btn btn-sm btn-warning btn-sua"><i class="bi bi-pencil"></i></button>
                         <button class="btn btn-sm btn-danger btn-xoa" data-id="${item.id}"><i class="bi bi-trash"></i></button>`
                    ]).draw();
                });
            },
            error: function (xhr, status, error) {
                console.error('Lỗi gọi API tiến độ:', status, error, xhr.responseText);
                alert('Không load được dữ liệu tiến độ. Kiểm tra console (F12) để xem chi tiết.');
            }
        });
    }

    // Load dữ liệu lần đầu
    loadTienDo();

    // Event nút Sửa
    $('#tblTienDo tbody').on('click', '.btn-sua', function () {
        let row = $(this).closest('tr');
        let id = row.find('.btn-xoa').data('id');
        let cells = row.find('td');

        $('#id').val(id);
        $('#ma_dk').val(cells.eq(0).text());
        $('#moc').val(cells.eq(1).text());
        $('#ngay_nop').val(cells.eq(2).text());
        $('#nhan_xet').val(cells.eq(3).text() === '-' ? '' : cells.eq(3).text());
        $('#diem').val(cells.eq(4).text() === '-' ? '' : cells.eq(4).text());
        $('#trang_thai').val(cells.eq(5).text().match(/>([^<]+)</)[1]); // Lấy text trạng thái

        $('#modalTitle').text('Sửa tiến độ');
        $('#modalTienDo').modal('show');
    });

    // Event nút Thêm mới
    $('#btnThemMoi').click(function () {
        $('#formTienDo')[0].reset();
        $('#id').val('');
        $('#ma_dk').val('Tự sinh');
        $('#modalTitle').text('Thêm tiến độ mới');
        $('#modalTienDo').modal('show');
    });

    // Event nút Xóa
    $('#tblTienDo tbody').on('click', '.btn-xoa', function () {
        let id = $(this).data('id');
        if (confirm('Bạn chắc chắn muốn xóa tiến độ này?')) {
            $.ajax({
                url: 'api/tiendo_api.php',
                method: 'DELETE',
                contentType: 'application/json',
                data: JSON.stringify({ id: id }),
                success: function () {
                    alert('Xóa thành công');
                    loadTienDo(); // Reload bảng
                },
                error: function (xhr) {
                    console.log(xhr.responseText);
                    alert('Lỗi khi xóa: ' + (xhr.responseJSON?.error || 'Không rõ'));
                }
            });
        }
    });

    // Lưu (Thêm hoặc Sửa)
    $('#btnLuuTienDo').click(function () {
        let id = $('#id').val();
        let url = 'api/tiendo_api.php';
        let method = id ? 'PUT' : 'POST';

        let data = {
            id: id || undefined,
            dang_ky_id: $('#ma_dk').val(),
            moc: $('#moc').val(),
            ngay_nop: $('#ngay_nop').val(),
            nhan_xet: $('#nhan_xet').val(),
            diem: $('#diem').val() || null,
            trang_thai: $('#trang_thai').val()
        };

        $.ajax({
            url: url,
            method: method,
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function (res) {
                alert(res.message || 'Lưu thành công');
                $('#modalTienDo').modal('hide');
                loadTienDo(); // Reload bảng
            },
            error: function (xhr) {
                console.log(xhr.responseText);
                alert('Lỗi khi lưu: ' + (xhr.responseJSON?.error || 'Không rõ'));
            }
        });
    });
});
</script>

</body>
</html>