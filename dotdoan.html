<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Đợt Đồ án</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.bootstrap5.min.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/2.0.8/js/dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/2.0.8/js/dataTables.bootstrap5.min.js"></script>
    <style>
        body { background: #f8f9fa; }
        .header { background: #0d6efd; color: white; padding: 15px; text-align: center; }
    </style>
</head>
<body>

<div class="header">
    <h3>QUẢN LÝ ĐỢT ĐỒ ÁN</h3>
    <a href="index.html" class="btn btn-light btn-sm">← Về trang chủ</a>
</div>

<div class="container my-5">
    <div class="mb-3 text-end">
        <button class="btn btn-success" id="btnThemMoi">
            <i class="bi bi-plus-lg"></i> Thêm đợt mới
        </button>
    </div>

    <table class="table table-bordered table-hover" id="tblDotDoAn">
        <thead class="table-primary">
            <tr>
                <th>Tên đợt</th>
                <th>Năm học</th>
                <th>Ngày mở đăng ký</th>
                <th>Ngày đóng đăng ký</th>
                <th>Ngày nộp cuối</th>
                <th>Ngày bảo vệ</th>
                <th>Trạng thái</th>
                <th>Thao tác</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- Modal Thêm/Sửa đợt đồ án -->
<div class="modal fade" id="modalDotDoAn" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Thêm đợt đồ án mới</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formDotDoAn">
                    <input type="hidden" id="id">
                    <div class="mb-3">
                        <label>Tên đợt</label>
                        <input type="text" class="form-control" id="ten_dot" required>
                    </div>
                    <div class="mb-3">
                        <label>Năm học</label>
                        <input type="text" class="form-control" id="nam_hoc" required>
                    </div>
                    <div class="mb-3">
                        <label>Ngày mở đăng ký</label>
                        <input type="date" class="form-control" id="ngay_mo_dk">
                    </div>
                    <div class="mb-3">
                        <label>Ngày đóng đăng ký</label>
                        <input type="date" class="form-control" id="ngay_dong_dk">
                    </div>
                    <div class="mb-3">
                        <label>Ngày nộp cuối</label>
                        <input type="date" class="form-control" id="ngay_nop_cuoi">
                    </div>
                    <div class="mb-3">
                        <label>Ngày bảo vệ</label>
                        <input type="date" class="form-control" id="ngay_bao_ve">
                    </div>
                    <div class="mb-3">
                        <label>Trạng thái</label>
                        <select class="form-select" id="trang_thai" required>
                            <option value="dang_mo">Đang mở</option>
                            <option value="da_dong">Đã đóng</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" id="btnLuuDotDoAn">Lưu</button>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function () {
    let table = $('#tblDotDoAn').DataTable({
        "pageLength": 10,
        "lengthMenu": [5, 10, 25, 50, "Tất cả"],
        "searching": true,
        "paging": true,
        "ordering": true,
        "info": true,
        "destroy": true // Cho phép khởi tạo lại nếu cần
    });

    // Hàm load dữ liệu từ API
    function loadDotDoAn() {
        $.ajax({
            url: 'api/dotdoan_api.php',
            method: 'GET',
            dataType: 'json',
            success: function (data) {
                console.log('Dữ liệu đợt đồ án từ API:', data); // Debug: mở F12 → Console xem dữ liệu có về không

                table.clear().draw();

                if (!data || data.length === 0) {
                    table.row.add(['', '<i>Chưa có đợt đồ án nào</i>', '', '', '', '', '', '']).draw();
                    return;
                }

                data.forEach(item => {
                    let trangThaiBadge = '';
                    switch (item.trang_thai) {
                        case 'dang_mo': trangThaiBadge = 'bg-success'; break;
                        case 'da_dong': trangThaiBadge = 'bg-secondary'; break;
                        default: trangThaiBadge = 'bg-secondary';
                    }

                    table.row.add([
                        item.ten_dot,
                        item.nam_hoc,
                        item.ngay_mo_dang_ky || '-',
                        item.ngay_dong_dang_ky || '-',
                        item.ngay_nop_cuoi || '-',
                        item.ngay_bao_ve || '-',
                        `<span class="badge ${trangThaiBadge}">${item.trang_thai}</span>`,
                        `<button class="btn btn-sm btn-warning btn-sua"><i class="bi bi-pencil"></i></button>
                         <button class="btn btn-sm btn-danger btn-xoa" data-id="${item.id}"><i class="bi bi-trash"></i></button>`
                    ]).draw();
                });
            },
            error: function (xhr, status, error) {
                console.error('Lỗi gọi API đợt đồ án:', status, error, xhr.responseText);
                alert('Không load được dữ liệu đợt đồ án. Kiểm tra console (F12) và API.');
            }
        });
    }

    // Load dữ liệu lần đầu
    loadDotDoAn();

    // Event nút Sửa
    $('#tblDotDoAn tbody').on('click', '.btn-sua', function () {
        let row = $(this).closest('tr');
        let id = row.find('.btn-xoa').data('id');
        let cells = row.find('td');

        $('#id').val(id);
        $('#ten_dot').val(cells.eq(0).text());
        $('#nam_hoc').val(cells.eq(1).text());
        $('#ngay_mo_dk').val(cells.eq(2).text());
        $('#ngay_dong_dk').val(cells.eq(3).text());
        $('#ngay_nop_cuoi').val(cells.eq(4).text());
        $('#ngay_bao_ve').val(cells.eq(5).text());
        $('#trang_thai').val(cells.eq(6).text().match(/>([^<]+)</)[1]); // Lấy text trạng thái

        $('#modalTitle').text('Sửa đợt đồ án');
        $('#modalDotDoAn').modal('show');
    });

    // Event nút Thêm mới
    $('#btnThemMoi').click(function () {
        $('#formDotDoAn')[0].reset();
        $('#id').val('');
        $('#modalTitle').text('Thêm đợt đồ án mới');
        $('#modalDotDoAn').modal('show');
    });

    // Event nút Xóa
    $('#tblDotDoAn tbody').on('click', '.btn-xoa', function () {
        let id = $(this).data('id');
        if (confirm('Bạn chắc chắn muốn xóa đợt đồ án này?')) {
            $.ajax({
                url: 'api/dotdoan_api.php',
                method: 'DELETE',
                contentType: 'application/json',
                data: JSON.stringify({ id: id }),
                success: function () {
                    alert('Xóa thành công');
                    loadDotDoAn(); // Reload bảng
                },
                error: function (xhr) {
                    console.log(xhr.responseText);
                    alert('Lỗi khi xóa: ' + (xhr.responseJSON?.error || 'Không rõ'));
                }
            });
        }
    });

    // Lưu (Thêm hoặc Sửa)
    $('#btnLuuDotDoAn').click(function () {
        let id = $('#id').val();
        let url = 'api/dotdoan_api.php';
        let method = id ? 'PUT' : 'POST';

        let data = {
            id: id || undefined,
            ten_dot: $('#ten_dot').val(),
            nam_hoc: $('#nam_hoc').val(),
            ngay_mo_dang_ky: $('#ngay_mo_dk').val() || null,
            ngay_dong_dang_ky: $('#ngay_dong_dk').val() || null,
            ngay_nop_cuoi: $('#ngay_nop_cuoi').val() || null,
            ngay_bao_ve: $('#ngay_bao_ve').val() || null,
            trang_thai: $('#trang_thai').val()
        };

        $.ajax({
            url: url,
            method: method,
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function (res) {
                alert(res.message || 'Lưu thành công');
                $('#modalDotDoAn').modal('hide');
                loadDotDoAn(); // Reload bảng
            },
            error: function (xhr) {
                console.log(xhr.responseText);
                alert('Lỗi khi lưu: ' + (xhr.responseJSON?.error || 'Không rõ'));
            }
        });
    });
});
</script>

</body>
</html>