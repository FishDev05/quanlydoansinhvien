<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Đăng ký Đề tài</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.bootstrap5.min.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/2.0.8/js/dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/2.0.8/js/dataTables.bootstrap5.min.js"></script>
    <style>
        body { background: #f8f9fa; }
        .header { background: #0d6efd; color: white; padding: 15px; text-align: center; }
    </style>
</head>
<body>

<div class="header">
    <h3>QUẢN LÝ ĐĂNG KÝ ĐỀ TÀI</h3>
    <a href="index.html" class="btn btn-light btn-sm">← Về trang chủ</a>
</div>

<div class="container my-5">
    <div class="mb-3 text-end">
        <button class="btn btn-success" id="btnThemMoi">
            <i class="bi bi-plus-lg"></i> Thêm đăng ký mới
        </button>
    </div>

    <table class="table table-bordered table-hover" id="tblDangKy">
        <thead class="table-primary">
            <tr>
                <th>Mã đăng ký</th>
                <th>Sinh viên (Mã số)</th>
                <th>Mã đề tài</th>
                <th>Ngày đăng ký</th>
                <th>Trạng thái</th>
                <th>Ghi chú</th>
                <th>Thao tác</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- Modal Thêm/Sửa -->
<div class="modal fade" id="modalDangKy" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Thêm đăng ký mới</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formDangKy">
                    <input type="hidden" id="id">
                    <div class="mb-3">
                        <label>Mã đăng ký</label>
                        <input type="text" class="form-control" id="ma_dk" readonly placeholder="Tự sinh">
                    </div>
                    <div class="mb-3">
                        <label>Sinh viên (Mã số)</label>
                        <input type="text" class="form-control" id="sinh_vien" required>
                    </div>
                    <div class="mb-3">
                        <label>Mã đề tài</label>
                        <input type="text" class="form-control" id="ma_de_tai" required>
                    </div>
                    <div class="mb-3">
                        <label>Ngày đăng ký</label>
                        <input type="date" class="form-control" id="ngay_dk" required>
                    </div>
                    <div class="mb-3">
                        <label>Trạng thái</label>
                        <select class="form-select" id="trang_thai" required>
                            <option value="">Chọn trạng thái</option>
                            <option value="cho_duyet">Chờ duyệt</option>
                            <option value="da_duyet">Đã duyệt</option>
                            <option value="tu_choi">Từ chối</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label>Ghi chú</label>
                        <textarea class="form-control" id="ghi_chu" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" id="btnLuuDangKy">Lưu</button>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function () {
    let table = $('#tblDangKy').DataTable({
        "pageLength": 10,
        "lengthMenu": [5, 10, 25, 50, "Tất cả"],
        "searching": true,
        "paging": true,
        "ordering": true,
        "info": true,
        "destroy": true // Cho phép khởi tạo lại nếu cần
    });

    // Hàm load dữ liệu từ API
    function loadDangKy() {
        $.ajax({
            url: 'api/dangky_api.php',
            method: 'GET',
            dataType: 'json',
            success: function (data) {
                console.log('Dữ liệu từ API đăng ký:', data); // Debug: mở F12 → Console xem dữ liệu có về không

                table.clear().draw();

                if (!data || data.length === 0) {
                    table.row.add(['', '<i>Chưa có đăng ký nào</i>', '', '', '', '', '']).draw();
                    return;
                }

                data.forEach(item => {
                    let trangThaiBadge = '';
                    switch (item.trang_thai) {
                        case 'da_duyet': trangThaiBadge = 'bg-success'; break;
                        case 'cho_duyet': trangThaiBadge = 'bg-warning'; break;
                        case 'tu_choi': trangThaiBadge = 'bg-danger'; break;
                        default: trangThaiBadge = 'bg-secondary';
                    }

                    table.row.add([
                        item.id,
                        item.sinh_vien_id, // Sau này join để hiển thị tên SV
                        item.de_tai_id,     // Sau này join để hiển thị tên đề tài
                        item.ngay_dang_ky || '-',
                        `<span class="badge ${trangThaiBadge}">${item.trang_thai}</span>`,
                        item.ghi_chu || '-',
                        `<button class="btn btn-sm btn-warning btn-sua"><i class="bi bi-pencil"></i></button>
                         <button class="btn btn-sm btn-danger btn-xoa" data-id="${item.id}"><i class="bi bi-trash"></i></button>`
                    ]).draw();
                });
            },
            error: function (xhr, status, error) {
                console.error('Lỗi gọi API đăng ký:', status, error, xhr.responseText);
                alert('Không load được dữ liệu đăng ký. Kiểm tra console (F12) và API.');
            }
        });
    }

    // Load dữ liệu lần đầu
    loadDangKy();

    // Event nút Sửa
    $('#tblDangKy tbody').on('click', '.btn-sua', function () {
        let row = $(this).closest('tr');
        let id = row.find('.btn-xoa').data('id');

        let cells = row.find('td');
        $('#id').val(id);
        $('#ma_dk').val(cells.eq(0).text());
        $('#sinh_vien').val(cells.eq(1).text());
        $('#ma_de_tai').val(cells.eq(2).text());
        $('#ngay_dk').val(cells.eq(3).text());
        $('#trang_thai').val(cells.eq(4).text().match(/>([^<]+)</)[1]); // Lấy text trạng thái
        $('#ghi_chu').val(cells.eq(5).text() === '-' ? '' : cells.eq(5).text());

        $('#modalTitle').text('Sửa đăng ký');
        $('#modalDangKy').modal('show');
    });

    // Event nút Thêm mới
    $('#btnThemMoi').click(function () {
        $('#formDangKy')[0].reset();
        $('#id').val('');
        $('#ma_dk').val('Tự sinh');
        $('#modalTitle').text('Thêm đăng ký mới');
        $('#modalDangKy').modal('show');
    });

    // Event nút Xóa
    $('#tblDangKy tbody').on('click', '.btn-xoa', function () {
        let id = $(this).data('id');
        if (confirm('Bạn chắc chắn muốn xóa đăng ký này?')) {
            $.ajax({
                url: 'api/dangky_api.php',
                method: 'DELETE',
                contentType: 'application/json',
                data: JSON.stringify({ id: id }),
                success: function () {
                    alert('Xóa thành công');
                    loadDangKy(); // Reload bảng
                },
                error: function (xhr) {
                    console.log(xhr.responseText);
                    alert('Lỗi khi xóa: ' + (xhr.responseJSON?.error || 'Không rõ'));
                }
            });
        }
    });

    // Lưu (Thêm hoặc Sửa)
    $('#btnLuuDangKy').click(function () {
        let id = $('#id').val();
        let url = 'api/dangky_api.php';
        let method = id ? 'PUT' : 'POST';

        let data = {
            id: id || undefined,
            de_tai_id: $('#ma_de_tai').val(),
            sinh_vien_id: $('#sinh_vien').val(),
            dot_do_an_id: 1, // ← Thay bằng giá trị thật (thêm select dot_do_an nếu cần)
            trang_thai: $('#trang_thai').val(),
            ghi_chu: $('#ghi_chu').val()
        };

        $.ajax({
            url: url,
            method: method,
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function (res) {
                alert(res.message || 'Lưu thành công');
                $('#modalDangKy').modal('hide');
                loadDangKy(); // Reload bảng
            },
            error: function (xhr) {
                console.log(xhr.responseText);
                alert('Lỗi khi lưu: ' + (xhr.responseJSON?.error || 'Không rõ'));
            }
        });
    });
});
</script>

</body>
</html>