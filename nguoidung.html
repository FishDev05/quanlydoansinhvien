<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Người dùng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.bootstrap5.min.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/2.0.8/js/dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/2.0.8/js/dataTables.bootstrap5.min.js"></script>
    <style>
        body { background: #f8f9fa; }
        .header { background: #0d6efd; color: white; padding: 15px; text-align: center; }
    </style>
</head>
<body>

<div class="header">
    <h3>QUẢN LÝ NGƯỜI DÙNG</h3>
    <a href="index.html" class="btn btn-light btn-sm">← Về trang chủ</a>
</div>

<div class="container my-5">
    <div class="mb-3 text-end">
        <button class="btn btn-success" id="btnThemMoi">
            <i class="bi bi-plus-lg"></i> Thêm người dùng
        </button>
    </div>

    <table class="table table-bordered table-hover" id="tblNguoiDung">
        <thead class="table-primary">
            <tr>
                <th>Mã số</th>
                <th>Họ tên</th>
                <th>Email</th>
                <th>Vai trò</th>
                <th>Khoa</th>
                <th>Thao tác</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- Modal Thêm/Sửa người dùng -->
<div class="modal fade" id="modalNguoiDung" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Thêm người dùng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formNguoiDung">
                    <input type="hidden" id="id">
                    <div class="mb-3">
                        <label>Mã số</label>
                        <input type="text" class="form-control" id="ma_so" required>
                    </div>
                    <div class="mb-3">
                        <label>Họ tên</label>
                        <input type="text" class="form-control" id="ho_ten" required>
                    </div>
                    <div class="mb-3">
                        <label>Email</label>
                        <input type="email" class="form-control" id="email" required>
                    </div>
                    <div class="mb-3">
                        <label>Vai trò</label>
                        <select class="form-select" id="vai_tro" required>
                            <option value="sinh_vien">Sinh viên</option>
                            <option value="giang_vien">Giảng viên</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label>Khoa</label>
                        <input type="text" class="form-control" id="khoa" value="Công nghệ Thông tin">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" id="btnLuuNguoiDung">Lưu</button>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function () {
    let table = $('#tblNguoiDung').DataTable({
        "pageLength": 10,
        "lengthMenu": [5, 10, 25, 50, "Tất cả"],
        "searching": true,
        "paging": true,
        "ordering": true,
        "info": true,
        "destroy": true  // Cho phép khởi tạo lại nếu cần
    });

    // Hàm load dữ liệu từ API
    function loadNguoiDung() {
        $.ajax({
            url: 'api/nguoidung_api.php',
            method: 'GET',
            dataType: 'json',
            success: function (data) {
                console.log('Dữ liệu người dùng từ API:', data); // Debug: mở F12 → Console xem dữ liệu có về không

                table.clear().draw();

                if (!data || data.length === 0) {
                    table.row.add(['', '<i>Chưa có người dùng nào</i>', '', '', '', '']).draw();
                    return;
                }

                data.forEach(user => {
                    let vaiTroBadge = '';
                    switch (user.vai_tro) {
                        case 'sinh_vien': vaiTroBadge = 'bg-success'; break;
                        case 'giang_vien': vaiTroBadge = 'bg-info'; break;
                        case 'admin': vaiTroBadge = 'bg-danger'; break;
                        default: vaiTroBadge = 'bg-secondary';
                    }

                    table.row.add([
                        user.ma_so,
                        user.ho_ten,
                        user.email,
                        `<span class="badge ${vaiTroBadge}">${user.vai_tro}</span>`,
                        user.khoa || '-',
                        `<button class="btn btn-sm btn-warning btn-sua"><i class="bi bi-pencil"></i></button>
                         <button class="btn btn-sm btn-danger btn-xoa" data-id="${user.id}"><i class="bi bi-trash"></i></button>`
                    ]).draw();
                });
            },
            error: function (xhr, status, error) {
                console.error('Lỗi gọi API người dùng:', status, error, xhr.responseText);
                alert('Không load được dữ liệu người dùng. Kiểm tra console (F12).');
            }
        });
    }

    // Load dữ liệu lần đầu
    loadNguoiDung();

    // Event nút Sửa
    $('#tblNguoiDung tbody').on('click', '.btn-sua', function () {
        let row = $(this).closest('tr');
        let id = row.find('.btn-xoa').data('id');
        let cells = row.find('td');

        $('#id').val(id);
        $('#ma_so').val(cells.eq(0).text());
        $('#ho_ten').val(cells.eq(1).text());
        $('#email').val(cells.eq(2).text());
        $('#vai_tro').val(cells.eq(3).text().match(/>([^<]+)</)[1]); // Lấy text vai trò
        $('#khoa').val(cells.eq(4).text() === '-' ? 'Công nghệ Thông tin' : cells.eq(4).text());

        $('#modalTitle').text('Sửa người dùng');
        $('#modalNguoiDung').modal('show');
    });

    // Event nút Thêm mới
    $('#btnThemMoi').click(function () {
        $('#formNguoiDung')[0].reset();
        $('#id').val('');
        $('#khoa').val('Công nghệ Thông tin');
        $('#modalTitle').text('Thêm người dùng');
        $('#modalNguoiDung').modal('show');
    });

    // Event nút Xóa
    $('#tblNguoiDung tbody').on('click', '.btn-xoa', function () {
        let id = $(this).data('id');
        if (confirm('Xóa người dùng này?')) {
            $.ajax({
                url: 'api/nguoidung_api.php',
                method: 'DELETE',
                contentType: 'application/json',
                data: JSON.stringify({ id: id }),
                success: function () {
                    alert('Xóa thành công');
                    loadNguoiDung(); // Reload bảng
                },
                error: function (xhr) {
                    console.log(xhr.responseText);
                    alert('Lỗi khi xóa: ' + (xhr.responseJSON?.error || 'Không rõ'));
                }
            });
        }
    });

    // Lưu (Thêm hoặc Sửa)
    $('#btnLuuNguoiDung').click(function () {
        let id = $('#id').val();
        let url = 'api/nguoidung_api.php';
        let method = id ? 'PUT' : 'POST';

        let data = {
            id: id || undefined,
            ma_so: $('#ma_so').val(),
            ho_ten: $('#ho_ten').val(),
            email: $('#email').val(),
            vai_tro: $('#vai_tro').val(),
            khoa: $('#khoa').val()
        };

        $.ajax({
            url: url,
            method: method,
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function (res) {
                alert(res.message || 'Lưu thành công');
                $('#modalNguoiDung').modal('hide');
                loadNguoiDung(); // Reload bảng
            },
            error: function (xhr) {
                console.log(xhr.responseText);
                alert('Lỗi khi lưu: ' + (xhr.responseJSON?.error || 'Không rõ'));
            }
        });
    });
});
</script>

</body>
</html>