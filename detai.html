<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Đề tài</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.bootstrap5.min.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/2.0.8/js/dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/2.0.8/js/dataTables.bootstrap5.min.js"></script>
    <style>
        body { background: #f8f9fa; }
        .header { background: #0d6efd; color: white; padding: 15px; text-align: center; }
    </style>
</head>
<body>

<div class="header">
    <h3>QUẢN LÝ ĐỀ TÀI</h3>
    <a href="index.html" class="btn btn-light btn-sm">← Về trang chủ</a>
</div>

<div class="container my-5">
    <div class="mb-3 text-end">
        <button class="btn btn-success" id="btnThemMoi">
            <i class="bi bi-plus-lg"></i> Thêm đề tài
        </button>
    </div>

    <table class="table table-bordered table-hover" id="tblDetai">
        <thead class="table-primary">
            <tr>
                <th>Mã</th>
                <th>Tên đề tài</th>
                <th>Lĩnh vực</th>
                <th>GVHD</th>
                <th>Số SV tối đa</th>
                <th>Trạng thái</th>
                <th>Thao tác</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- Modal Thêm/Sửa đề tài -->
<div class="modal fade" id="modalDetai" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Thêm đề tài</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formDetai">
                    <input type="hidden" id="id">
                    <div class="mb-3">
                        <label>Mã đề tài</label>
                        <input type="text" class="form-control" id="ma_de_tai" required>
                    </div>
                    <div class="mb-3">
                        <label>Tên đề tài</label>
                        <input type="text" class="form-control" id="ten_de_tai" required>
                    </div>
                    <div class="mb-3">
                        <label>Lĩnh vực</label>
                        <select class="form-select" id="linh_vuc" required>
                            <option value="">Chọn lĩnh vực</option>
                            <option value="1">Công nghệ phần mềm</option>
                            <option value="2">Trí tuệ nhân tạo</option>
                            <!-- Thêm các lĩnh vực khác nếu có -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label>GV hướng dẫn</label>
                        <select class="form-select" id="giang_vien" required>
                            <option value="">Chọn giảng viên</option>
                            <option value="2">Nguyễn Thị Lan</option>
                            <option value="3">Trần Văn Hùng</option>
                            <!-- Thêm giảng viên khác nếu cần -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label>Số SV tối đa</label>
                        <input type="number" class="form-control" id="so_luong_sv_max" min="1" value="1" required>
                    </div>
                    <div class="mb-3">
                        <label>Trạng thái</label>
                        <select class="form-select" id="trang_thai" required>
                            <option value="mo">Mở</option>
                            <option value="dong">Đóng</option>
                            <option value="da_hoan_thanh">Hoàn thành</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" id="btnLuuDetai">Lưu</button>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function () {
    let table = $('#tblDetai').DataTable({
        "pageLength": 10,
        "lengthMenu": [5, 10, 25, 50, "Tất cả"],
        "searching": true,
        "paging": true,
        "ordering": true,
        "info": true,
        "destroy": true  // Cho phép khởi tạo lại nếu cần
    });

    // Hàm load dữ liệu từ API
    function loadDeTai() {
        $.ajax({
            url: 'api/detai_api.php',
            method: 'GET',
            dataType: 'json',
            success: function (data) {
                console.log('Dữ liệu đề tài từ API:', data); // Debug: mở F12 → Console xem dữ liệu có về không

                table.clear().draw();

                if (!data || data.length === 0) {
                    table.row.add(['', '<i>Chưa có đề tài nào</i>', '', '', '', '', '']).draw();
                    return;
                }

                data.forEach(dt => {
                    let trangThaiBadge = '';
                    switch (dt.trang_thai) {
                        case 'mo': trangThaiBadge = 'bg-success'; break;
                        case 'dong': trangThaiBadge = 'bg-warning'; break;
                        case 'da_hoan_thanh': trangThaiBadge = 'bg-secondary'; break;
                        default: trangThaiBadge = 'bg-secondary';
                    }

                    table.row.add([
                        dt.ma_de_tai,
                        dt.ten_de_tai,
                        dt.linh_vuc || '-',
                        dt.giang_vien || '-',
                        dt.so_luong_sv_toi_da || '1',
                        `<span class="badge ${trangThaiBadge}">${dt.trang_thai}</span>`,
                        `<button class="btn btn-sm btn-warning btn-sua"><i class="bi bi-pencil"></i></button>
                         <button class="btn btn-sm btn-danger btn-xoa" data-id="${dt.id}"><i class="bi bi-trash"></i></button>`
                    ]).draw();
                });
            },
            error: function (xhr, status, error) {
                console.error('Lỗi gọi API đề tài:', status, error, xhr.responseText);
                alert('Không load được dữ liệu đề tài. Kiểm tra console (F12).');
            }
        });
    }

    // Load dữ liệu lần đầu
    loadDeTai();

    // Event nút Sửa
    $('#tblDetai tbody').on('click', '.btn-sua', function () {
        let row = $(this).closest('tr');
        let id = row.find('.btn-xoa').data('id');
        let cells = row.find('td');

        $('#id').val(id);
        $('#ma_de_tai').val(cells.eq(0).text());
        $('#ten_de_tai').val(cells.eq(1).text());
        $('#linh_vuc').val(cells.eq(2).text()); // Nếu có select value
        $('#giang_vien').val(cells.eq(3).text()); // Nếu có select value
        $('#so_luong_sv_max').val(cells.eq(4).text());
        $('#trang_thai').val(cells.eq(5).text().match(/>([^<]+)</)[1]);

        $('#modalTitle').text('Sửa đề tài');
        $('#modalDetai').modal('show');
    });

    // Event nút Thêm mới
    $('#btnThemMoi').click(function () {
        $('#formDetai')[0].reset();
        $('#id').val('');
        $('#so_luong_sv_max').val('1');
        $('#modalTitle').text('Thêm đề tài');
        $('#modalDetai').modal('show');
    });

    // Event nút Xóa
    $('#tblDetai tbody').on('click', '.btn-xoa', function () {
        let id = $(this).data('id');
        if (confirm('Xóa đề tài này?')) {
            $.ajax({
                url: 'api/detai_api.php',
                method: 'DELETE',
                contentType: 'application/json',
                data: JSON.stringify({ id: id }),
                success: function () {
                    alert('Xóa thành công');
                    loadDeTai(); // Reload bảng
                },
                error: function (xhr) {
                    console.log(xhr.responseText);
                    alert('Lỗi khi xóa: ' + (xhr.responseJSON?.error || 'Không rõ'));
                }
            });
        }
    });

    // Lưu (Thêm hoặc Sửa)
    $('#btnLuuDetai').click(function () {
        let id = $('#id').val();
        let url = 'api/detai_api.php';
        let method = id ? 'PUT' : 'POST';

        let data = {
            id: id || undefined,
            ma_de_tai: $('#ma_de_tai').val(),
            ten_de_tai: $('#ten_de_tai').val(),
            linh_vuc: $('#linh_vuc').val(),
            giang_vien: $('#giang_vien').val(),
            so_luong_sv_max: $('#so_luong_sv_max').val(),
            trang_thai: $('#trang_thai').val()
        };

        $.ajax({
            url: url,
            method: method,
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function (res) {
                alert(res.message || 'Lưu thành công');
                $('#modalDetai').modal('hide');
                loadDeTai(); // Reload bảng
            },
            error: function (xhr) {
                console.log(xhr.responseText);
                alert('Lỗi khi lưu: ' + (xhr.responseJSON?.error || 'Không rõ'));
            }
        });
    });
});
</script>

</body>
</html>